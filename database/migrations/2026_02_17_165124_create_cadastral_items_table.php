<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Выполняется при запуске миграции (php artisan migrate)
     * Создает таблицу для хранения кадастровых номеров в рамках поручений
     */
    public function up(): void
    {
        /**
         * Создание новой таблицы 'cadastral_items' (кадастровые номера)
         * -------------------------------------------------------------
         * Эта таблица хранит все кадастровые номера, по которым нужно выполнить работы
         * Каждая запись - это один кадастровый номер в рамках конкретного поручения
         * Связана с таблицей external_orders (одно поручение -> много номеров)
         */
        Schema::create('cadastral_items', function (Blueprint $table) {
            
            /**
             * ПОЛЕ: id (первичный ключ)
             * -------------------------
             * Автоматически инкрементируемый уникальный идентификатор
             * Используется для внутренних связей (например, с отчетами)
             */
            $table->id();
            
            /**
             * ******************************************************************
             * БЛОК 1: СВЯЗЬ С ПОРУЧЕНИЕМ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: external_order_id (внешний ключ к таблице поручений)
             * -----------------------------------------------------------
             * - Ссылается на таблицу external_orders (поле id)
             * - Определяет, к какому поручению относится этот кадастровый номер
             * - Одно поручение может содержать МНОГО кадастровых номеров
             * - NOT NULL (обязательное поле)
             */
            $table->foreignId('external_order_id')
                  /**
                   * constrained() автоматически создает внешний ключ
                   * Означает: external_order_id REFERENCES external_orders(id)
                   */
                  ->constrained()
                  
                  /**
                   * onDelete('cascade') - каскадное удаление
                   * ----------------------------------------
                   * Что происходит при удалении поручения из external_orders:
                   * - ВСЕ связанные кадастровые номера УДАЛЯЮТСЯ автоматически
                   * - Не нужно удалять их вручную
                   * - Сохраняет целостность данных (нет "сиротских" записей)
                   */
                  ->onDelete('cascade');
            
            /**
             * ******************************************************************
             * БЛОК 2: ОСНОВНЫЕ ПОЛЯ (ДАННЫЕ О КАДАСТРОВОМ ОБЪЕКТЕ)
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: cadastral_number (кадастровый номер)
             * ------------------------------------------
             * - Уникальный идентификатор объекта недвижимости в ЕГРН
             * - Формат: АА:ББ:ВВВВВВ:КК (регион:район:квартал:номер)
             * - Пример: 50:09:0070504:123
             * - NOT NULL (обязательное поле)
             * - Уникальность проверяется отдельно (см. unique ниже)
             */
            $table->string('cadastral_number');
            
            /**
             * ПОЛЕ: object_type (тип объекта недвижимости)
             * --------------------------------------------
             * - Что это за объект по документам
             * - Возможные значения:
             *   - 'Земельный участок' (самое частое в ККР)
             *   - 'Здание' (жилой дом, гараж, сарай)
             *   - 'Сооружение' (мост, труба, ЛЭП)
             *   - 'Помещение' (квартира, офис - редко в ККР)
             *   - 'Объект незавершенного строительства'
             *   - 'Машино-место'
             *   - 'Единый недвижимый комплекс'
             * - NOT NULL (обязательное поле)
             */
            $table->string('object_type');
            
            /**
             * ПОЛЕ: work_type (тип выполняемых работ / результат)
             * ----------------------------------------------------
             * - Какой документ нужно подготовить по этому объекту
             * - Возможные значения:
             *   - 'Отчет' (отчет о выполненных ККР)
             *   - 'Заключение' (заключение кадастрового инженера)
             *   - 'Акт согласования' (акт согласования границ)
             *   - 'Карта-план' (карта-план территории)
             *   - 'Межевой план' (при уточнении границ)
             *   - 'Технический план' (для зданий)
             *   - 'Акт обследования' (при сносе)
             * - NOT NULL (обязательное поле)
             */
            $table->string('work_type');
            
            /**
             * ПОЛЕ: status (текущий статус выполнения)
             * ----------------------------------------
             * - Где находится работа по этому номеру
             * - Значение по умолчанию: 'assigned' (назначен)
             * - Возможные статусы:
             *   - 'assigned'    (назначен) - задача создана, исполнитель назначен
             *   - 'in_progress' (в работе) - исполнитель начал работу
             *   - 'completed'   (выполнен) - работа завершена, есть результат
             *   - 'problem'     (проблема) - возникли сложности (нужно внимание)
             *   - 'checking'    (на проверке) - результат проверяется
             * - NOT NULL (обязательное поле)
             */
            $table->string('status')->default('assigned');
            
            /**
             * ******************************************************************
             * БЛОК 3: ИСПОЛНИТЕЛЬ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: assigned_to (кому назначено)
             * -----------------------------------
             * - Внешний ключ к таблице users (поле id)
             * - Кто из сотрудников отвечает за этот кадастровый номер
             * - Может быть NULL (еще не назначен или исполнитель удален)
             * - Один сотрудник может иметь МНОГО назначенных номеров
             */
            $table->foreignId('assigned_to')
                  ->nullable()              // разрешаем NULL
                  ->constrained('users');    // ссылка на таблицу users
            
            /**
             * ******************************************************************
             * БЛОК 4: ДАТА ЗАВЕРШЕНИЯ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: completion_date (дата завершения работы)
             * ----------------------------------------------
             * - Когда работа по этому номеру была выполнена
             * - Заполняется только при статусе 'completed'
             * - Может быть NULL (пока не выполнено)
             * - Формат: YYYY-MM-DD
             * - Используется для статистики и отчетов
             */
            $table->date('completion_date')->nullable();
            
            /**
             * ******************************************************************
             * БЛОК 5: КОММЕНТАРИЙ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: comment (комментарий исполнителя)
             * ---------------------------------------
             * - Текстовое поле для заметок
             * - Исполнитель может писать:
             *   - Что сделано
             *   - С какими проблемами столкнулся
             *   - Дополнительная информация по объекту
             * - Может быть NULL (необязательное поле)
             */
            $table->text('comment')->nullable();
            
            /**
             * ******************************************************************
             * БЛОК 6: СЛУЖЕБНЫЕ ПОЛЯ LARAVEL
             * ******************************************************************
             */
            
            /**
             * ПОЛЯ: created_at и updated_at (метки времени)
             * ----------------------------------------------
             * - created_at - когда задача была создана в системе
             * - updated_at - когда последний раз меняли статус/комментарий
             * - Заполняются автоматически Laravel
             */
            $table->timestamps();
            
            /**
             * ******************************************************************
             * БЛОК 7: УНИКАЛЬНОСТЬ И ИНДЕКСЫ
             * ******************************************************************
             */
            
            /**
             * УНИКАЛЬНОСТЬ: unique_cadastral_per_order
             * -----------------------------------------
             * - Составной уникальный ключ (external_order_id + cadastral_number)
             * - Гарантирует, что в ОДНОМ поручении не будет дублей кадастрового номера
             * - Пример ошибки: нельзя дважды добавить 50:09:0070504:123 в поручение №1
             * - Но один и тот же номер может быть в РАЗНЫХ поручениях (это нормально)
             * - 'unique_cadastral_per_order' - имя индекса (для удобства)
             */
            $table->unique(['external_order_id', 'cadastral_number'], 'unique_cadastral_per_order');
            
            /**
             * ИНДЕКС: status
             * --------------
             * Ускоряет поиск по статусу
             * Частые запросы: "показать все проблемы", "сколько выполненных"
             */
            $table->index('status');
            
            /**
             * ИНДЕКС: assigned_to
             * -------------------
             * Ускоряет поиск по исполнителю
             * Частые запросы: "что назначено Иванову", "загруженность сотрудников"
             */
            $table->index('assigned_to');
            
            /**
             * ИНДЕКС: object_type
             * -------------------
             * Ускоряет фильтрацию по типу объекта
             * Редко, но может пригодиться для статистики
             */
            $table->index('object_type');
            
            /**
             * ИНДЕКС: work_type
             * -----------------
             * Ускоряет фильтрацию по типу работ
             * Например: "сколько отчетов нужно сделать"
             */
            $table->index('work_type');
            
            /**
             * ИНДЕКС: completion_date
             * -----------------------
             * Ускоряет поиск по дате завершения
             * Для отчетов: "что выполнено в этом месяце"
             */
            $table->index('completion_date');
            
            /**
             * ПРИМЕЧАНИЕ ПО ИНДЕКСАМ:
             * Индексы ускоряют ЧТЕНИЕ (SELECT), но замедляют ЗАПИСЬ (INSERT/UPDATE)
             * Здесь созданы индексы только для часто используемых полей
             */
        });
        
        /**
         * ПОЯСНЕНИЕ ПО СВЯЗЯМ:
         * ====================
         * Таблица cadastral_items связана с:
         * - external_orders (через external_order_id) - родительское поручение
         * - users (через assigned_to) - исполнитель
         * 
         * Схема связей:
         * external_orders (1) -------- (*) cadastral_items
         * users (1) -------- (*) cadastral_items
         * 
         * То есть:
         * - У одного поручения МНОГО кадастровых номеров
         * - У одного исполнителя МНОГО назначенных номеров
         */
    }

    /**
     * Reverse the migrations.
     * Выполняется при откате миграции (php artisan migrate:rollback)
     * Удаляет таблицу cadastral_items полностью
     */
    public function down(): void
    {
        /**
         * Удаление таблицы 'cadastral_items'
         * ----------------------------------
         * При откате миграции таблица будет полностью удалена из БД
         * ВНИМАНИЕ: Все данные по кадастровым номерам будут потеряны!
         * 
         * Порядок удаления важен:
         * 1. Сначала должна удаляться cadastral_items (дочерняя)
         * 2. Потом external_orders (родительская)
         * 
         * Если удалить external_orders первой, то:
         * - Из-за внешнего ключа будет ошибка
         * - Либо сработает onDelete('cascade') и удалит всё автоматически
         */
        Schema::dropIfExists('cadastral_items');
        
        /**
         * dropIfExists() безопаснее чем drop():
         * - Если таблицы нет - ничего не произойдет
         * - Если есть - удалит
         */
    }
};

/**
 * КРАТКАЯ ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ:
 * ======================================
 * 
 * 1. Запуск миграции:
 *    php artisan migrate
 * 
 *    ВАЖНО: Таблица external_orders должна существовать!
 *    Эта миграция должна запускаться ПОСЛЕ создания external_orders
 * 
 * 2. Откат этой миграции:
 *    php artisan migrate:rollback --step=1
 * 
 * 3. Типовые запросы к таблице:
 *    
 *    -- Сколько всего номеров в поручении
 *    SELECT COUNT(*) FROM cadastral_items WHERE external_order_id = 1;
 *    
 *    -- Сколько выполнено
 *    SELECT COUNT(*) FROM cadastral_items 
 *    WHERE external_order_id = 1 AND status = 'completed';
 *    
 *    -- Загруженность сотрудников
 *    SELECT assigned_to, COUNT(*) as task_count 
 *    FROM cadastral_items 
 *    WHERE status != 'completed' 
 *    GROUP BY assigned_to;
 *    
 *    -- Просроченные задачи (если добавить поле deadline)
 *    -- (с текущей структурой - просто все невыполненные)
 * 
 * 4. Пример вставки тестовых данных:
 *    INSERT INTO cadastral_items 
 *    (external_order_id, cadastral_number, object_type, work_type, status, assigned_to)
 *    VALUES 
 *    (1, '50:09:0070504:123', 'Земельный участок', 'Отчет', 'assigned', 2),
 *    (1, '50:09:0070504:124', 'Здание', 'Технический план', 'in_progress', 3),
 *    (1, '50:09:0070504:125', 'Земельный участок', 'Акт согласования', 'completed', 2);
 */

/**
 * ВОЗМОЖНЫЕ РАСШИРЕНИЯ (на будущее):
 * ===================================
 * 
 * 1. Добавить поле priority (приоритет):
 *    $table->string('priority')->default('medium');
 * 
 * 2. Добавить поле deadline (срок выполнения):
 *    $table->date('deadline')->nullable();
 * 
 * 3. Добавить поле result_file (ссылка на файл с результатом):
 *    $table->string('result_file')->nullable();
 * 
 * 4. Добавить поле parent_id (для иерархии объектов):
 *    $table->foreignId('parent_id')->nullable()->constrained('cadastral_items');
 * 
 * 5. Использовать справочники вместо строк:
 *    - object_type_id -> object_types.id
 *    - work_type_id -> work_types.id
 *    - status_id -> item_statuses.id
 */