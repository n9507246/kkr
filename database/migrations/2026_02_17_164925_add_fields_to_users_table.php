<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Выполняется при запуске миграции (php artisan migrate)
     */
    public function up(): void
    {
        /**
         * Изменяем существующую таблицу 'users'
         * Добавляем новые поля, необходимые для работы отдела ККР
         */
        Schema::table('users', function (Blueprint $table) {
            
            /**
             * ПОЛЕ: username (имя пользователя для входа в систему)
             * -------------------------------------------------------
             * - Добавляется ПОСЛЕ поля 'id' (чтобы было первым в списке)
             * - Уникальное значение (не может повторяться)
             * - Будет использоваться для входа вместо email
             * - Пример: ivanov_ii, petrov_pp, sidorova_aa
             */
            $table->string('username')->unique()->after('id');
            
            /**
             * ПОЛЕ: full_name (полное имя / ФИО сотрудника)
             * ---------------------------------------------
             * - Добавляется ПОСЛЕ поля 'username'
             * - Хранит полное имя сотрудника для отображения в интерфейсе
             * - Пример: Иванов Иван Иванович, Петров Петр Петрович
             */
            $table->string('full_name')->after('username');
            
            /**
             * ПОЛЕ: role (роль пользователя в системе)
             * ----------------------------------------
             * - Добавляется ПОСЛЕ поля 'email' (чтобы было логично)
             * - Значение по умолчанию: 'executor' (исполнитель)
             * - Возможные значения:
             *   - 'manager'    (руководитель) - может создавать поручения и назначать задачи
             *   - 'executor'   (исполнитель)  - может выполнять задачи по кадастровым номерам
             * - В будущем можно расширить (admin, viewer и т.д.)
             */
            $table->string('role')->default('executor')->after('email');
            
            /**
             * ПОЛЕ: active (статус активности сотрудника)
             * -------------------------------------------
             * - Добавляется ПОСЛЕ поля 'role'
             * - Логический тип (true/false)
             * - Значение по умолчанию: true (активен)
             * - true  - сотрудник работает, может заходить в систему
             * - false - сотрудник уволен или в отпуске, доступ заблокирован
             * - Позволяет "мягко" отключать пользователей без удаления из БД
             */
            $table->boolean('active')->default(true)->after('role');
            
            /**
             * ПРИМЕЧАНИЕ: Поля 'name', 'email', 'password' и 'timestamps'
             * уже существуют в стандартной таблице users от Laravel
             * 
             * После добавления этих полей таблица users будет содержать:
             * - id (первичный ключ)
             * - username (новое) - для входа
             * - full_name (новое) - ФИО
             * - name (старое) - можно оставить или заполнить из full_name
             * - email (старое) - для уведомлений (опционально)
             * - role (новое) - роль в системе
             * - active (новое) - статус активности
             * - password - пароль
             * - remember_token - для "запомнить меня"
             * - timestamps - created_at, updated_at
             */
        });
    }

    /**
     * Reverse the migrations.
     * Выполняется при откате миграции (php artisan migrate:rollback)
     * Удаляет добавленные поля, возвращая таблицу в исходное состояние
     */
    public function down(): void
    {
        /**
         * Удаляем все добавленные поля из таблицы 'users'
         * Если потребуется откатить миграцию, эти поля будут удалены
         * Порядок удаления не важен - просто список имен полей
         */
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn([
                'username',   // удаляем поле для входа
                'full_name',  // удаляем поле ФИО
                'role',       // удаляем поле роли
                'active'      // удаляем поле активности
            ]);
            
            /**
             * Важно: при откате миграции удаляются ТОЛЬКО эти поля
             * Остальные поля (id, name, email, password и т.д.) сохраняются
             * Таблица возвращается к стандартному виду Laravel
             */
        });
    }
};

/**
 * КРАТКАЯ ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ:
 * ======================================
 * 
 * 1. Запуск миграции:
 *    php artisan migrate
 * 
 * 2. Откат миграции (если нужно вернуть назад):
 *    php artisan migrate:rollback
 * 
 * 3. Проверка статуса миграций:
 *    php artisan migrate:status
 * 
 * 4. После добавления полей не забудьте обновить модель User:
 *    - Добавить 'username', 'full_name', 'role', 'active' в $fillable
 *    - Добавить метод username() для аутентификации
 *    - Добавить проверки ролей (isManager(), isExecutor())
 */