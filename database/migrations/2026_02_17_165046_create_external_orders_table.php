<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Выполняется при запуске миграции (php artisan migrate)
     * Создает таблицу для хранения внешних поручений от УРР
     */
    public function up(): void
    {
        /**
         * Создание новой таблицы 'external_orders' (внешние поручения)
         * Эта таблица хранит все входящие поручения от Управления Росреестра (УРР)
         * Одно поручение может содержать множество кадастровых номеров для отработки
         */
        Schema::create('external_orders', function (Blueprint $table) {
            
            /**
             * ПОЛЕ: id (первичный ключ)
             * -------------------------
             * Автоматически инкрементируемый уникальный идентификатор
             * Используется для внутренних связей с другими таблицами
             */
            $table->id();
            
            /**
             * ******************************************************************
             * БЛОК 1: ВХОДЯЩИЕ РЕКВИЗИТЫ (ВАШИ - ОТДЕЛ ККР)
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: incoming_number (входящий номер документа)
             * ------------------------------------------------
             * - Уникальное значение (не может повторяться)
             * - Это номер, который присваивается письму в вашем отделе/канцелярии
             * - По нему вы ищете документ в своем делопроизводстве
             * - Пример: ВХ-123/2025, ВХ-45/2025, 12-ВХ/2025
             */
            $table->string('incoming_number')->unique();
            
            /**
             * ПОЛЕ: incoming_date (дата регистрации входящего документа)
             * ----------------------------------------------------------
             * - Дата, когда письмо от УРР поступило в ваш отдел
             * - Может отличаться от даты письма УРР (почта идет несколько дней)
             * - Используется для внутреннего учета и статистики
             * - Формат: YYYY-MM-DD (в БД), в приложении отображается как ДД.ММ.ГГГГ
             */
            $table->date('incoming_date');
            
            /**
             * ******************************************************************
             * БЛОК 2: РЕКВИЗИТЫ ПИСЬМА УРР (ИХ ДАННЫЕ)
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: urr_number (номер письма из УРР)
             * --------------------------------------
             * - Номер, который указан в самом письме от Росреестра
             * - Обычно находится в углу письма: "На № ... от ..."
             * - Используется для ссылок в ответных письмах
             * - Пример: 12-3456/25, 78-АБ/2025, 09-ККР/2025
             */
            $table->string('urr_number');
            
            /**
             * ПОЛЕ: urr_date (дата письма из УРР)
             * -----------------------------------
             * - Дата, которая стоит в письме УРР (когда они его подписали)
             * - Может быть раньше, чем incoming_date
             * - Важно для правильного делопроизводства и ответов
             * - Формат: YYYY-MM-DD
             */
            $table->date('urr_date');
            
            /**
             * ******************************************************************
             * БЛОК 3: ОПИСАНИЕ ПОРУЧЕНИЯ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: description (описание поручения)
             * --------------------------------------
             * - Краткое содержание или тема поручения
             * - Может быть null (необязательное поле)
             * - Пример: "Провести ККР в кадастровом квартале 50:09:0070504"
             * - Пример: "Уточнить границы земельных участков в СНТ 'Березка'"
             */
            $table->text('description')->nullable();
            
            /**
             * ******************************************************************
             * БЛОК 4: СВЯЗЬ С ПОЛЬЗОВАТЕЛЯМИ
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: created_by (кто создал запись)
             * -------------------------------------
             * - Внешний ключ, ссылается на таблицу users (поле id)
             * - Хранит ID пользователя, который внес это поручение в систему
             * - Может быть null (если пользователь удален)
             * - constrained('users') автоматически создает внешний ключ
             */
            $table->foreignId('created_by')->nullable()->constrained('users');
            
            /**
             * ******************************************************************
             * БЛОК 5: ИСХОДЯЩЕЕ ПИСЬМО (ОТВЕТ)
             * ******************************************************************
             */
            
            /**
             * ПОЛЕ: outgoing_number (исходящий номер ответа)
             * ----------------------------------------------
             * - Номер письма, которое вы отправили в ответ в УРР
             * - Заполняется после того, как все работы выполнены и отчет готов
             * - Может быть null (пока ответ не отправлен)
             * - Пример: ИСХ-456/2025, 78-ОТВ/2025
             */
            $table->string('outgoing_number')->nullable();
            
            /**
             * ПОЛЕ: outgoing_date (дата исходящего письма)
             * --------------------------------------------
             * - Дата, когда вы отправили ответ в УРР
             * - Заполняется вместе с outgoing_number
             * - Может быть null (пока ответ не отправлен)
             * - Формат: YYYY-MM-DD
             */
            $table->date('outgoing_date')->nullable();
            
            /**
             * ******************************************************************
             * БЛОК 6: СЛУЖЕБНЫЕ ПОЛЯ LARAVEL
             * ******************************************************************
             */
            
            /**
             * ПОЛЯ: created_at и updated_at (метки времени)
             * ----------------------------------------------
             * - created_at - дата и время создания записи
             * - updated_at - дата и время последнего изменения
             * - Заполняются автоматически Laravel
             */
            $table->timestamps();
            
            /**
             * ******************************************************************
             * БЛОК 7: ИНДЕКСЫ ДЛЯ УСКОРЕНИЯ ПОИСКА
             * ******************************************************************
             */
            
            /**
             * ИНДЕКС: incoming_date
             * ---------------------
             * Ускоряет поиск и фильтрацию по дате регистрации
             * Часто ищут: "показать все поручения за последний месяц"
             */
            $table->index('incoming_date');
            
            /**
             * ИНДЕКС: urr_date
             * ----------------
             * Ускоряет поиск по дате письма УРР
             */
            $table->index('urr_date');
            
            /**
             * ИНДЕКС: outgoing_date
             * ---------------------
             * Ускоряет поиск по дате отправки ответа
             * Полезно для отчетности: "сколько ответов отправили в этом месяце"
             */
            $table->index('outgoing_date');
            
            /**
             * ПРИМЕЧАНИЕ: Индексы не созданы для текстовых полей
             * (description, urr_number, incoming_number), так как:
             * - incoming_number уже имеет UNIQUE индекс
             * - urr_number не так часто ищут
             * - description - текстовое поле, полнотекстовый поиск сложнее
             */
        });
        
        /**
         * ПОЯСНЕНИЕ ПО СВЯЗЯМ:
         * ====================
         * Таблица external_orders связана с:
         * - users (через created_by) - кто создал поручение
         * - cadastral_items (через внешний ключ в той таблице) - список кадастровых номеров
         * 
         * Связи в БД:
         * users (1) -------- (*) external_orders (один пользователь может создать много поручений)
         * external_orders (1) -------- (*) cadastral_items (одно поручение содержит много кадастровых номеров)
         */
    }

    /**
     * Reverse the migrations.
     * Выполняется при откате миграции (php artisan migrate:rollback)
     * Удаляет таблицу external_orders полностью
     */
    public function down(): void
    {
        /**
         * Удаление таблицы 'external_orders'
         * При откате миграции таблица будет полностью удалена из БД
         * ВНИМАНИЕ: Все данные в таблице будут безвозвратно потеряны!
         * 
         * Если есть связанные таблицы (например, cadastral_items), 
         * они должны быть удалены ПОСЛЕ этой таблицы, 
         * либо иметь ON DELETE CASCADE
         */
        Schema::dropIfExists('external_orders');
        
        /**
         * dropIfExists() безопаснее чем drop():
         * - если таблицы нет - ничего не произойдет
         * - если таблица есть - удалит её
         */
    }
};

/**
 * КРАТКАЯ ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ:
 * ======================================
 * 
 * 1. Запуск миграции:
 *    php artisan migrate
 * 
 * 2. Откат этой миграции (если нужно):
 *    php artisan migrate:rollback --step=1
 * 
 * 3. Проверка создания таблицы:
 *    - Зайти в БД: php artisan db
 *    - Показать таблицы: .tables (SQLite) или SHOW TABLES; (MySQL)
 *    - Описать структуру: PRAGMA table_info(external_orders);
 * 
 * 4. Связанные таблицы (создавать после этой):
 *    - cadastral_items - кадастровые номера в поручении
 * 
 * 5. Пример вставки тестовых данных:
 *    INSERT INTO external_orders 
 *    (incoming_number, incoming_date, urr_number, urr_date, description, created_by)
 *    VALUES 
 *    ('ВХ-001/2025', '2025-02-17', '12-3456/25', '2025-02-10', 
 *     'Провести ККР в квартале 50:09:0070504', 1);
 */