<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Выполняется при запуске миграции (php artisan migrate)
     * Создает таблицу-справочник для типов выполняемых работ (результатов)
     */
    public function up(): void
    {
        /**
         * Создание таблицы 'work_types' (типы работ / результаты)
         * -------------------------------------------------------
         * Это справочная таблица (справочник)
         * Хранит предопределенные типы работ/результатов для выбора в cadastral_items
         * Определяет, какой именно документ нужно подготовить по кадастровому номеру
         * 
         * Преимущества справочника:
         * - Стандартизация названий документов
         * - Исключение разночтений ("Отчет" vs "Отчёт" vs "Отчет о работах")
         * - Легко добавлять новые виды работ
         * - Удобно для отчетности и статистики
         */
        Schema::create('work_types', function (Blueprint $table) {
            
            /**
             * ПОЛЕ: id (первичный ключ)
             * -------------------------
             * Автоматически инкрементируемый уникальный идентификатор
             * Будет использоваться как внешний ключ в cadastral_items
             * (если решим перейти от строк к справочнику)
             */
            $table->id();
            
            /**
             * ПОЛЕ: code (уникальный код типа работ)
             * --------------------------------------
             * - Уникальное значение (не может повторяться)
             * - Короткий код для использования в коде приложения
             * - Не изменяется, даже если меняется название
             * - Используется в логике (условия, переключатели)
             * - Примеры:
             *   - 'report'          - отчет о выполненных ККР
             *   - 'conclusion'      - заключение кадастрового инженера
             *   - 'approval_act'    - акт согласования границ
             *   - 'map_plan'        - карта-план территории
             *   - 'boundary_plan'   - межевой план
             *   - 'technical_plan'  - технический план
             *   - 'survey_act'      - акт обследования
             *   - 'extract'         - выписка из ЕГРН
             */
            $table->string('code')->unique();
            
            /**
             * ПОЛЕ: name (название типа работ)
             * ---------------------------------
             * - Человекочитаемое название для отображения в интерфейсе
             * - Будет показываться в выпадающих списках
             * - NOT NULL (обязательное поле)
             * - Примеры:
             *   - "Отчет о выполненных ККР"
             *   - "Заключение кадастрового инженера"
             *   - "Акт согласования границ"
             *   - "Карта-план территории"
             *   - "Межевой план"
             *   - "Технический план"
             *   - "Акт обследования"
             */
            $table->string('name');
            
            /**
             * ПОЛЕ: description (описание)
             * ----------------------------
             * - Подробное описание типа работ
             * - Для каких случаев применяется
             * - Какие документы входят в состав
             * - Может быть NULL (необязательное)
             * - Полезно для обучения новых сотрудников
             * - Можно использовать как подсказку в интерфейсе
             */
            $table->text('description')->nullable();
            
            /**
             * ПОЛЯ: created_at и updated_at (метки времени)
             * ----------------------------------------------
             * - created_at - когда тип работ был добавлен в справочник
             * - updated_at - когда последний раз меняли название/описание
             */
            $table->timestamps();
        });
        
        /**
         * ПОЯСНЕНИЕ ПО ИСПОЛЬЗОВАНИЮ:
         * ===========================
         * 
         * Эта таблица будет связана с cadastral_items ЕСЛИ мы решим
         * заменить строковое поле work_type на внешний ключ.
         * 
         * Сейчас в cadastral_items:
         * $table->string('work_type'); // хранит строку "Отчет о выполненных ККР"
         * 
         * Можно изменить на:
         * $table->foreignId('work_type_id')->constrained('work_types');
         * 
         * Преимущества такого подхода:
         * - Экономия места в БД (хранится число, а не строка)
         * - Изменение названия в одном месте меняет его везде
         * - Нет дублирования данных
         * - Легче делать отчеты по группам
         * - Нельзя ошибиться при вводе (выбор из списка)
         */
    }

    /**
     * Reverse the migrations.
     * Выполняется при откате миграции (php artisan migrate:rollback)
     * Удаляет таблицу work_types полностью
     */
    public function down(): void
    {
        /**
         * Удаление таблицы 'work_types'
         * ----------------------------
         * ВНИМАНИЕ: Если другие таблицы ссылаются на эту через внешний ключ,
         * сначала нужно удалить те таблицы или убрать внешние ключи
         * Иначе будет ошибка внешнего ключа
         */
        Schema::dropIfExists('work_types');
    }
};

/**
 * ТЕСТОВЫЕ ДАННЫЕ ДЛЯ ЗАПОЛНЕНИЯ СПРАВОЧНИКА:
 * ============================================
 * 
 * После создания таблицы нужно заполнить её начальными данными.
 * Создайте Seeder:
 * 
 * php artisan make:seeder WorkTypesTableSeeder
 */

/**
 * ПРИМЕР SEEDER ДЛЯ ТАБЛИЦЫ WORK_TYPES:
 * ======================================
 * 
 * <?php
 * 
 * namespace Database\Seeders;
 * 
 * use Illuminate\Database\Seeder;
 * use Illuminate\Support\Facades\DB;
 * 
 * class WorkTypesTableSeeder extends Seeder
 * {
 *     public function run(): void
 *     {
 *         $types = [
 *             // Основные виды работ в ККР
 *             [
 *                 'code' => 'report',
 *                 'name' => 'Отчет о выполненных ККР',
 *                 'description' => 'Итоговый отчет по результатам комплексных кадастровых работ. Содержит сведения обо всех выполненных действиях и полученных результатах.'
 *             ],
 *             [
 *                 'code' => 'conclusion',
 *                 'name' => 'Заключение кадастрового инженера',
 *                 'description' => 'Документ, содержащий выводы кадастрового инженера по результатам анализа документов и измерений.'
 *             ],
 *             [
 *                 'code' => 'approval_act',
 *                 'name' => 'Акт согласования границ',
 *                 'description' => 'Документ, подтверждающий согласование местоположения границ земельного участка с соседями.'
 *             ],
 *             
 *             // Документы для отдельных объектов
 *             [
 *                 'code' => 'map_plan',
 *                 'name' => 'Карта-план территории',
 *                 'description' => 'Документ, содержащий графическое отображение территории и сведения о расположенных на ней объектах.'
 *             ],
 *             [
 *                 'code' => 'boundary_plan',
 *                 'name' => 'Межевой план',
 *                 'description' => 'Документ для уточнения границ земельного участка или образования новых участков.'
 *             ],
 *             [
 *                 'code' => 'technical_plan',
 *                 'name' => 'Технический план',
 *                 'description' => 'Документ для постановки на учет здания, сооружения или помещения.'
 *             ],
 *             [
 *                 'code' => 'survey_act',
 *                 'name' => 'Акт обследования',
 *                 'description' => 'Документ, подтверждающий снос или прекращение существования объекта недвижимости.'
 *             ],
 *             
 *             // Дополнительные документы
 *             [
 *                 'code' => 'extract',
 *                 'name' => 'Выписка из ЕГРН',
 *                 'description' => 'Официальный документ, содержащий актуальные сведения об объекте недвижимости.'
 *             ],
 *             [
 *                 'code' => 'notification',
 *                 'name' => 'Уведомление заинтересованных лиц',
 *                 'description' => 'Документ, подтверждающий уведомление участников процесса о проведении работ.'
 *             ],
 *         ];
 * 
 *         foreach ($types as $type) {
 *             DB::table('work_types')->insert([
 *                 'code' => $type['code'],
 *                 'name' => $type['name'],
 *                 'description' => $type['description'],
 *                 'created_at' => now(),
 *                 'updated_at' => now(),
 *             ]);
 *         }
 *     }
 * }
 * 
 * Запуск seeder:
 * php artisan db:seed --class=WorkTypesTableSeeder
 */

/**
 * ПРИМЕРЫ ЗАПРОСОВ К ТАБЛИЦЕ:
 * ============================
 * 
 * -- Получить все типы работ для выпадающего списка (сортировка по названию)
 * SELECT id, name FROM work_types ORDER BY name;
 * 
 * -- Получить только основные виды работ (первые 5)
 * SELECT name FROM work_types LIMIT 5;
 * 
 * -- Найти код по названию (для логики в коде приложения)
 * SELECT code FROM work_types WHERE name LIKE '%отчет%';
 * 
 * -- Получить описание для подсказки при выборе
 * SELECT name, description FROM work_types WHERE code = 'report';
 * 
 * -- Статистика использования типов работ (если добавим внешний ключ)
 * SELECT wt.name, COUNT(ci.id) as usage_count
 * FROM work_types wt
 * LEFT JOIN cadastral_items ci ON wt.id = ci.work_type_id
 * GROUP BY wt.id, wt.name
 * ORDER BY usage_count DESC;
 */

/**
 * ИСПОЛЬЗОВАНИЕ В ДРУГИХ ТАБЛИЦАХ:
 * =================================
 * 
 * Если решите использовать эту таблицу как справочник,
 * нужно изменить cadastral_items:
 * 
 * // Вместо строки:
 * // $table->string('work_type');
 * 
 * // Использовать внешний ключ:
 * $table->foreignId('work_type_id')->nullable()->constrained('work_types');
 * 
 * Тогда в модели CadastralItem нужно добавить связь:
 * 
 * public function workType()
 * {
 *     return $this->belongsTo(WorkType::class);
 * }
 * 
 * Получение названия типа работ:
 * $item->workType->name
 * 
 * Пример использования в контроллере:
 * $workTypes = WorkType::all(); // все типы для выпадающего списка
 */

/**
 * ЛОГИКА РАБОТЫ С ТИПАМИ В ПРИЛОЖЕНИИ:
 * =====================================
 * 
 * 1. При создании кадастрового номера:
 *    - Показываем выпадающий список из work_types
 *    - Сохраняем work_type_id
 * 
 * 2. При отображении задачи:
 *    - Показываем $item->workType->name
 *    - Можно показывать description как подсказку
 * 
 * 3. При фильтрации задач:
 *    - WHERE work_type_id = 1 (все отчеты)
 *    - WHERE work_type_id IN (2,3) (заключения и акты)
 * 
 * 4. При формировании отчетности:
 *    - Группировка по work_type_id
 *    - Подсчет количества каждого типа работ
 */

/**
 * ПЛЮСЫ И МИНУСЫ ИСПОЛЬЗОВАНИЯ СПРАВОЧНИКА:
 * ==========================================
 * 
 * ПЛЮСЫ ДЛЯ ТИПОВ РАБОТ:
 * + Единообразие названий в системе (нет "Отчет" и "Отчёт")
 * + Легко добавлять новые типы работ без миграции БД
 * + Можно сортировать по приоритету (добавив поле sort_order)
 * + Возможность добавлять метаданные (сроки выполнения, стоимость)
 * + Удобно для фильтрации и группировки в отчетах
 * 
 * МИНУСЫ:
 * - Нужно заполнять справочник при установке
 * - Дополнительный JOIN в запросах
 * - Чуть сложнее структура БД
 * 
 * РЕКОМЕНДАЦИЯ:
 * Для отдела ККР использование справочника типов работ ОЧЕНЬ ПОЛЕЗНО, потому что:
 * - Виды работ четко определены регламентами
 * - Их количество стабильно (5-10 видов)
 * - Важно считать статистику по видам работ
 * - Названия должны быть официальными и единообразными
 */

/**
 * ВОЗМОЖНЫЕ РАСШИРЕНИЯ СПРАВОЧНИКА (на будущее):
 * ==============================================
 * 
 * 1. Добавить поле sort_order для сортировки:
 *    $table->integer('sort_order')->default(0);
 * 
 * 2. Добавить поле is_active для отключения устаревших типов:
 *    $table->boolean('is_active')->default(true);
 * 
 * 3. Добавить поле default_days (срок выполнения по умолчанию):
 *    $table->integer('default_days')->nullable();
 * 
 * 4. Добавить поле category для группировки:
 *    $table->string('category')->nullable(); // 'main', 'additional', 'report'
 * 
 * 5. Добавить поле color для визуального выделения:
 *    $table->string('color')->nullable(); // #FF0000 для проблемных
 */

/**
 * ИНТЕГРАЦИЯ С ДРУГИМИ ТАБЛИЦАМИ:
 * ================================
 * 
 * Таблица work_types может использоваться:
 * 1. В cadastral_items - какой результат нужно получить
 * 2. В reports - какие типы работ вошли в отчет
 * 3. В statistics - для аналитики по видам деятельности
 * 4. В templates - для связи с шаблонами документов
 * 
 * Пример сложной связи:
 * work_types (1) -------- (*) cadastral_items
 * work_types (1) -------- (*) report_templates
 * work_types (1) -------- (*) work_instructions
 */