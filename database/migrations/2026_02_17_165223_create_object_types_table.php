<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Выполняется при запуске миграции (php artisan migrate)
     * Создает таблицу-справочник для типов объектов недвижимости
     */
    public function up(): void
    {
        /**
         * Создание таблицы 'object_types' (типы объектов недвижимости)
         * ------------------------------------------------------------
         * Это справочная таблица (справочник)
         * Хранит предопределенные типы объектов для выбора в cadastral_items
         * Преимущества справочника:
         * - Исключает опечатки (пользователи выбирают из списка)
         * - Легко добавлять новые типы
         * - Можно менять названия, не трогая основные таблицы
         * - Удобно для перевода и отчетов
         */
        Schema::create('object_types', function (Blueprint $table) {
            
            /**
             * ПОЛЕ: id (первичный ключ)
             * -------------------------
             * Автоматически инкрементируемый уникальный идентификатор
             * Будет использоваться как внешний ключ в cadastral_items
             * (если решим перейти от строк к справочнику)
             */
            $table->id();
            
            /**
             * ПОЛЕ: code (уникальный код типа объекта)
             * ---------------------------------------
             * - Уникальное значение (не может повторяться)
             * - Короткий код для использования в коде приложения
             * - Не изменяется, даже если меняется название
             * - Примеры:
             *   - 'zu'           - земельный участок
             *   - 'building'     - здание
             *   - 'construction' - сооружение
             *   - 'premise'      - помещение
             *   - 'unfinished'   - объект незавершенного строительства
             *   - 'parking'      - машино-место
             *   - 'complex'      - единый недвижимый комплекс
             *   - 'mzu'          - многоконтурный земельный участок
             */
            $table->string('code')->unique();
            
            /**
             * ПОЛЕ: name (название типа объекта)
             * ----------------------------------
             * - Человекочитаемое название для отображения в интерфейсе
             * - Может меняться со временем (например, "Земельный участок" -> "Участок")
             * - Будет показываться в выпадающих списках
             * - NOT NULL (обязательное поле)
             * - Примеры: "Земельный участок", "Здание", "Сооружение"
             */
            $table->string('name');
            
            /**
             * ПОЛЕ: description (описание)
             * ----------------------------
             * - Подробное описание типа объекта
             * - Для чего используется, какие особенности
             * - Может быть NULL (необязательное)
             * - Полезно для подсказок в интерфейсе
             * - Пример: "Участок земли с установленными границами"
             */
            $table->text('description')->nullable();
            
            /**
             * ПОЛЯ: created_at и updated_at (метки времени)
             * ----------------------------------------------
             * - created_at - когда тип был добавлен в справочник
             * - updated_at - когда последний раз меняли название/описание
             * - Заполняются автоматически Laravel
             */
            $table->timestamps();
            
            /**
             * ПРИМЕЧАНИЕ: Индексы
             * -------------------
             * code уже имеет UNIQUE индекс (автоматически от unique())
             * Дополнительные индексы не нужны, таблица маленькая
             */
        });
        
        /**
         * ПОЯСНЕНИЕ ПО ИСПОЛЬЗОВАНИЮ:
         * ===========================
         * 
         * Эта таблица будет связана с cadastral_items ЕСЛИ мы решим
         * заменить строковое поле object_type на внешний ключ.
         * 
         * Сейчас в cadastral_items:
         * $table->string('object_type'); // хранит строку "Земельный участок"
         * 
         * Можно изменить на:
         * $table->foreignId('object_type_id')->constrained('object_types');
         * 
         * Преимущества такого подхода:
         * - Экономия места в БД (хранится число, а не строка)
         * - Изменение названия в одном месте меняет его везде
         * - Нет дублирования данных
         * - Легче делать отчеты по группам
         */
    }

    /**
     * Reverse the migrations.
     * Выполняется при откате миграции (php artisan migrate:rollback)
     * Удаляет таблицу object_types полностью
     */
    public function down(): void
    {
        /**
         * Удаление таблицы 'object_types'
         * -------------------------------
         * ВНИМАНИЕ: Если другие таблицы ссылаются на эту через внешний ключ,
         * сначала нужно удалить те таблицы или убрать внешние ключи
         * 
         * dropIfExists() безопасно удаляет таблицу, если она существует
         */
        Schema::dropIfExists('object_types');
    }
};

/**
 * ТЕСТОВЫЕ ДАННЫЕ ДЛЯ ЗАПОЛНЕНИЯ СПРАВОЧНИКА:
 * ============================================
 * 
 * После создания таблицы нужно заполнить её начальными данными.
 * Это можно сделать через Seeder:
 * 
 * php artisan make:seeder ObjectTypesTableSeeder
 * 
 * В seeder:
 * 
 * public function run()
 * {
 *     DB::table('object_types')->insert([
 *         ['code' => 'zu', 'name' => 'Земельный участок', 
 *          'description' => 'Земельный участок с установленными или уточняемыми границами'],
 *         
 *         ['code' => 'building', 'name' => 'Здание', 
 *          'description' => 'Капитальное строение (жилой дом, гараж, хозпостройка)'],
 *         
 *         ['code' => 'construction', 'name' => 'Сооружение', 
 *          'description' => 'Инженерное сооружение (мост, труба, ЛЭП)'],
 *         
 *         ['code' => 'premise', 'name' => 'Помещение', 
 *          'description' => 'Часть здания (квартира, комната, офис)'],
 *         
 *         ['code' => 'unfinished', 'name' => 'Объект незавершенного строительства', 
 *          'description' => 'Недостроенный объект, строительство заморожено'],
 *         
 *         ['code' => 'parking', 'name' => 'Машино-место', 
 *          'description' => 'Парковочное место в здании или на парковке'],
 *         
 *         ['code' => 'complex', 'name' => 'Единый недвижимый комплекс', 
 *          'description' => 'Совокупность зданий и сооружений, объединенных назначением'],
 *         
 *         ['code' => 'mzu', 'name' => 'Многоконтурный земельный участок', 
 *          'description' => 'Земельный участок, состоящий из нескольких обособленных контуров'],
 *     ]);
 * }
 * 
 * Запуск seeder:
 * php artisan db:seed --class=ObjectTypesTableSeeder
 */

/**
 * ПРИМЕРЫ ЗАПРОСОВ К ТАБЛИЦЕ:
 * ============================
 * 
 * -- Получить все типы для выпадающего списка
 * SELECT id, name FROM object_types ORDER BY name;
 * 
 * -- Найти код по названию (для логики в коде)
 * SELECT code FROM object_types WHERE name = 'Земельный участок';
 * 
 * -- Получить описание для подсказки
 * SELECT description FROM object_types WHERE code = 'zu';
 */

/**
 * ИСПОЛЬЗОВАНИЕ В ДРУГИХ ТАБЛИЦАХ:
 * =================================
 * 
 * Если решите использовать эту таблицу как справочник,
 * нужно изменить cadastral_items:
 * 
 * // Вместо строки:
 * // $table->string('object_type');
 * 
 * // Использовать внешний ключ:
 * $table->foreignId('object_type_id')->nullable()->constrained('object_types');
 * 
 * Тогда в модели CadastralItem нужно добавить связь:
 * 
 * public function objectType()
 * {
 *     return $this->belongsTo(ObjectType::class);
 * }
 * 
 * Получение названия типа:
 * $item->objectType->name
 */

/**
 * ПЛЮСЫ И МИНУСЫ ИСПОЛЬЗОВАНИЯ СПРАВОЧНИКА:
 * ==========================================
 * 
 * ПЛЮСЫ:
 * + Консистентность данных (нет "Земельный участок" и "Зем. участок")
 * + Легкость изменений (изменили название - обновилось везде)
 * + Меньше места в БД (int вместо string)
 * + Удобно для отчетов и группировок
 * 
 * МИНУСЫ:
 * - Сложнее структура (дополнительная таблица)
 * - Больше JOIN-ов в запросах
 * - Нужно заполнять справочник при установке
 * 
 * КОГДА ИСПОЛЬЗОВАТЬ:
 * - Если типов много (больше 5-10)
 * - Если типы могут меняться
 * - Если нужна поддержка нескольких языков
 * 
 * КОГДА НЕ НУЖНО:
 * - Если типов мало и они фиксированы
 * - Если проект маленький и простой
 * - Если нужна максимальная простота
 */

/**
 * АЛЬТЕРНАТИВНЫЙ ВАРИАНТ (без справочника):
 * =========================================
 * 
 * Если оставить как есть в cadastral_items:
 * $table->enum('object_type', [
 *     'Земельный участок',
 *     'Здание',
 *     'Сооружение',
 *     'Помещение',
 *     'Объект незавершенного строительства',
 *     'Машино-место',
 *     'Единый недвижимый комплекс',
 *     'Многоконтурный земельный участок'
 * ]);
 * 
 * Это проще, но менее гибко (нельзя добавить тип без миграции)
 */